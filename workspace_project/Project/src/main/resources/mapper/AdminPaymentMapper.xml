<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.m4gi.mapper.admin.AdminPaymentMapper">

    <!-- 전체 결제 목록 조회 -->
    <select id="findAllPayments" resultType="com.m4gi.dto.admin.AdminPaymentDetailDTO">
        SELECT
            p.payment_id,
            p.reservation_id,
            u.nickname AS user_nickname,
            z.zone_name AS campground_name,
            p.payment_price,
            p.payment_method,
            p.payment_status,
            p.paid_at
        FROM payments p
        JOIN reservations r on p.reservation_id = r.reservation_id
        JOIN users u ON r.provider_code = u.provider_code AND r.provider_user_id = u.provider_user_id
        JOIN campground_sites s ON r.reservation_site = s.site_id
        JOIN campground_zones z on s.zone_id = z.zone_id

    </select>

    <!-- 예약 ID로 결제 상세 조회 -->
    <select id="findPaymentByReservationId" parameterType="String" resultType="com.m4gi.dto.admin.AdminPaymentDetailDTO">
        SELECT
        p.payment_id,
        p.reservation_id,
        u.nickname AS user_nickname,
        u.phone AS user_phone,
        z.zone_name AS campground_name,
        r.reservation_site,
        r.checkin_time,
        r.checkout_time,
        r.reservation_status,
        r.refund_status,
        r.cancel_reason,
        r.requested_at,
        r.refunded_at,
        p.payment_price,
        p.payment_method,
        p.payment_status,
        p.payment_price,
        p.refund_amount,
        p.fee_amount,
        p.refund_type,
        p.paid_at
        FROM payments p
        JOIN reservations r ON p.reservation_id = r.reservation_id
        JOIN users u ON r.provider_code = u.provider_code AND r.provider_user_id = u.provider_user_id
        JOIN campground_sites s ON r.reservation_site = s.site_id
        JOIN campground_zones z ON s.zone_id = z.zone_id
        WHERE p.reservation_id = #{reservationId}
    </select>

    <update id="updatePaymentStatus">
        UPDATE payments
        SET payment_status = #{paymentStatus}
        WHERE reservation_id = #{reservationId}
    </update>


</mapper>