<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
        
<mapper namespace="com.m4gi.mapper.CampgroundMapper">
	
	<!-- 캠핑장 목록 조회 -->
	<select id="selectSearchedCampgrounds" parameterType="CampgroundCardDTO" resultMap="CampgroundCardResultMap">
	    SELECT
	        c.campground_id AS campgroundId,
	        c.campground_name AS campgroundName,
	        c.addr_sido AS addrSido,
	        c.addr_sigungu AS addrSigungu,
	        c.campground_type AS campgroundTypeString, 
	        ROUND(COALESCE(AVG(r.review_rating), 0)) AS reviewRatingAvg,
	        SUM(cs.current_stock) AS totalCurrentStock,
	        JSON_UNQUOTE(JSON_EXTRACT(c.campground_image, '$[0]')) AS campgroundImage,
	        CASE 
	            WHEN EXISTS (
	                SELECT 1 FROM wishlists w 
	                WHERE w.provider_code = #{providerCode}
	                AND w.provider_user_id = #{providerUserId}
	                AND w.wishlist_type = 1
	                AND w.campground_id = c.campground_id
	            )
	            THEN 1 ELSE 0
	        END AS isWishlisted
	    FROM campgrounds c
	    LEFT JOIN reviews r ON c.campground_id = r.campground_id
	    LEFT JOIN campground_sites cs ON c.campground_id = cs.campground_id
	    WHERE c.campground_name LIKE CONCAT('%', #{campgroundName}, '%')
	    
	    <if test="addrSiGunguList != null and !addrSiGunguList.isEmpty()">
	        AND c.addr_sigungu IN
	        <foreach item="sigungu" collection="addrSiGunguList" open="(" separator="," close=")">
	            #{sigungu}
	        </foreach>
	    </if>
	
	    AND NOT EXISTS (
	        SELECT 1
	        FROM campground_closed_dates cd
	        WHERE cd.campground_id = c.campground_id
	        AND (
	            (cd.closed_start_date &lt;= #{startDate} AND cd.closed_end_date &gt;= #{startDate}) OR
	            (cd.closed_start_date &lt;= #{endDate} AND cd.closed_end_date &gt;= #{endDate}) OR
	            (cd.closed_start_date &gt;= #{startDate} AND cd.closed_end_date &lt;= #{endDate})
	        )
	    )
	
	    AND EXISTS (
	        SELECT 1
	        FROM campground_sites cs_inner
	        WHERE cs_inner.campground_id = c.campground_id
	        AND cs_inner.capacity >= #{people}
	        AND NOT EXISTS (
	            SELECT 1
	            FROM reservations r2
	            WHERE r2.reservation_site = cs_inner.site_id
	            AND r2.reservation_date BETWEEN #{startDate} AND #{endDate}
	        )
	    )
	
	    GROUP BY c.campground_id, c.campground_name, c.addr_sido, c.addr_sigungu, c.campground_type
	</select>
	
	<resultMap id="CampgroundCardResultMap" type="com.m4gi.dto.CampgroundCardDTO">
	    <id property="campgroundId" column="campgroundId"/>
	    <result property="campgroundName" column="campgroundName"/>
	    <result property="addrSido" column="addrSido"/>
	    <result property="addrSigungu" column="addrSigungu"/>
	    <result property="reviewRatingAvg" column="reviewRatingAvg"/>
	    <result property="totalCurrentStock" column="totalCurrentStock"/>
	    <result property="isWishlisted" column="isWishlisted"/>
	    
	    <result property="campgroundType" column="campgroundTypeString" typeHandler="com.m4gi.handler.CsvSetTypeHandler"/>
	    <result property="campgroundImage" column="campgroundImage"/>
	</resultMap>
	<!-- 캠핑장 목록 조회 -->

	<!-- 상세 페이지 -->
	<select id="selectCampgroundById" parameterType="CampgroundCardDTO" resultType="java.util.Map">
		SELECT *
		FROM campgrounds
		WHERE campground_id = #{campgroundId}
	</select>
	
</mapper>