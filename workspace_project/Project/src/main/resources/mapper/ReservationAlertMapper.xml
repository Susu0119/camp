<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.m4gi.mapper.ReservationAlertMapper">

    <!-- ReservationAlertDTOì™€ DB ì»¬ëŸ¼/ê³„ì‚°ëœ í•„ë“œë¥¼ ë§¤í•‘í•˜ëŠ” resultMap -->
    <resultMap id="ReservationAlertResultMap" type="com.m4gi.dto.ReservationAlertDTO">
        <result property="reservationId" column="r_reservation_id"/>
        <result property="campgroundName" column="cg_campground_name"/>
        <result property="alertMessage" column="alert_message"/>
        <result property="alertTimestamp" column="alert_timestamp"/> <!-- ë™ì ìœ¼ë¡œ ê³„ì‚°ëœ ì‹œê°„ ìŠ¤íƒ¬í”„ -->
        <result property="alertType" column="alert_type"/> <!-- ë™ì ìœ¼ë¡œ ê³„ì‚°ëœ ì•Œë¦¼ íƒ€ì… -->
    </resultMap>

    <!-- íŠ¹ì • ì‚¬ìš©ìì—ê²Œ í•´ë‹¹í•˜ëŠ” ì˜ˆì•½ ì•Œë¦¼ì„ ë™ì ìœ¼ë¡œ ìƒì„±í•˜ì—¬ ì¡°íšŒí•˜ëŠ” ì¿¼ë¦¬ -->
    <select id="selectUserReservationAlerts" resultMap="ReservationAlertResultMap">
        SELECT
            r.reservation_id AS r_reservation_id,
            cg.campground_name AS cg_campground_name,
            CASE
                WHEN r.reservation_status = 1 AND DATE(r.created_at) = CURDATE() THEN CONCAT('\'', cg.campground_name, '\' ì˜ˆì•½ (ì˜ˆì•½ë²ˆí˜¸: ', r.reservation_id, ')ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì¦ê±°ìš´ ìº í•‘ ë˜ì„¸ìš”! ğŸ‰')
                WHEN r.reservation_status = 2 AND DATE(r.updated_at) = CURDATE() AND r.cancel_reason IS NOT NULL THEN CONCAT('\'', cg.campground_name, '\' ì˜ˆì•½ (ì˜ˆì•½ë²ˆí˜¸: ', r.reservation_id, ')ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤. ğŸ˜” (ì‚¬ìœ : ', COALESCE(r.custom_reason, r.cancel_reason, 'ì•Œ ìˆ˜ ì—†ìŒ'), ')')
                WHEN r.reservation_status = 1 AND DATEDIFF(r.reservation_date, CURDATE()) = 3 THEN CONCAT('\'', cg.campground_name, '\' ìº í•‘ ', DATEDIFF(r.reservation_date, CURDATE()), 'ì¼ ì „ì…ë‹ˆë‹¤! ì¤€ë¹„ ì˜ í•˜ì„¸ìš”!')
                WHEN r.reservation_status = 1 AND DATEDIFF(r.reservation_date, CURDATE()) = 1 THEN CONCAT('\'', cg.campground_name, '\' ìº í•‘ ', DATEDIFF(r.reservation_date, CURDATE()), 'ì¼ ì „ì…ë‹ˆë‹¤! ì§ ì±™ê¸°ì…¨ë‚˜ìš”?')
                WHEN r.reservation_status = 1 AND DATE(r.reservation_date) = CURDATE() THEN CONCAT('\'', cg.campground_name, '\' ì˜¤ëŠ˜ ìº í•‘ ì‹œì‘í•©ë‹ˆë‹¤! ì¦ê±°ìš´ ì‹œê°„ ë³´ë‚´ì„¸ìš”!')
                ELSE NULL
            END AS alert_message,
            CASE
               
                WHEN r.reservation_status = 1 AND DATE(r.created_at) = CURDATE() THEN r.created_at
                WHEN r.reservation_status = 2 AND DATE(r.updated_at) = CURDATE() THEN r.updated_at
                -- ë™ì  ì•Œë¦¼ (D-day ë“±)ì€ í˜„ì¬ ì‹œê°„ì„ ì•Œë¦¼ ì‹œê°„ ìŠ¤íƒ¬í”„ë¡œ ì‚¬ìš©
                WHEN r.reservation_status = 1 AND DATEDIFF(r.reservation_date, CURDATE()) IN (3, 1) THEN NOW()
                WHEN r.reservation_status = 1 AND DATE(r.reservation_date) = CURDATE() THEN NOW()
                ELSE NULL
            END AS alert_timestamp,
            CASE
              
                WHEN r.reservation_status = 1 AND DATE(r.created_at) = CURDATE() THEN 'RESERVATION_COMPLETED'
                WHEN r.reservation_status = 2 AND DATE(r.updated_at) = CURDATE() THEN 'RESERVATION_CANCELLED'
                WHEN r.reservation_status = 1 AND DATEDIFF(r.reservation_date, CURDATE()) IN (3, 1) THEN 'REMINDER_PRE_CAMP'
                WHEN r.reservation_status = 1 AND DATE(r.reservation_date) = CURDATE() THEN 'REMINDER_CAMP_TODAY'
                ELSE NULL
            END AS alert_type
        FROM
            reservations r
        JOIN
            campground_sites cs ON r.reservation_site = cs.site_id
        JOIN
            campgrounds cg ON cs.campground_id = cg.campground_id
        WHERE
            r.provider_code = #{providerCode}
            AND r.provider_user_id = #{providerUserId}
            AND (
                -- ì˜¤ëŠ˜ ìƒì„±ëœ ì˜ˆì•½ ì™„ë£Œ ì•Œë¦¼
                (r.reservation_status = 1 AND DATE(r.created_at) = CURDATE())
                -- ì˜¤ëŠ˜ ì·¨ì†Œëœ ì˜ˆì•½ ì•Œë¦¼
                OR (r.reservation_status = 2 AND DATE(r.updated_at) = CURDATE())
                -- ìº í•‘ 3ì¼ ì „ ë˜ëŠ” 1ì¼ ì „ ì•Œë¦¼ (ì˜ˆì•½ì´ í™œì„± ìƒíƒœì¸ ê²½ìš°)
                OR (r.reservation_status = 1 AND DATEDIFF(r.reservation_date, CURDATE()) IN (3, 1))
                -- ìº í•‘ ë‹¹ì¼ ì•Œë¦¼ (ì˜ˆì•½ì´ í™œì„± ìƒíƒœì¸ ê²½ìš°)
                OR (r.reservation_status = 1 AND DATE(r.reservation_date) = CURDATE())
            )
            AND cg.campground_name IS NOT NULL 
            AND (
                (CASE
                    WHEN r.reservation_status = 1 AND DATE(r.created_at) = CURDATE() THEN 1
                    WHEN r.reservation_status = 2 AND DATE(r.updated_at) = CURDATE() AND r.cancel_reason IS NOT NULL THEN 1
                    WHEN r.reservation_status = 1 AND DATEDIFF(r.reservation_date, CURDATE()) IN (3, 1) THEN 1
                    WHEN r.reservation_status = 1 AND DATE(r.reservation_date) = CURDATE() THEN 1
                    ELSE 0
                END) = 1
            )
        ORDER BY
            alert_timestamp DESC
    </select>
</mapper>